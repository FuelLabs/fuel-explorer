name: E2E Testnet Cron

on:
  schedule:
    # Runs daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
  # TODO: Remove after testing
  push:
    branches:
      - nj/feat/cron-e2e

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Target the deployed testnet explorer
  E2E_BASE_URL: https://app-testnet.fuel.network

  # Chain configuration for testnet
  FUEL_CHAIN_NAME: fuelTestnet
  FUEL_PROVIDER_URL: https://testnet.fuel.network/v1/graphql
  ETH_NETWORK: sepolia

  # Wallet mnemonics (from secrets - must have testnet funds)
  E2E_ETH_MNEMONIC: ${{ secrets.E2E_TESTNET_ETH_MNEMONIC }}
  E2E_FUEL_MNEMONIC: ${{ secrets.E2E_TESTNET_FUEL_MNEMONIC }}
  E2E_ETH_WALLET_PASSWORD: ${{ secrets.E2E_TESTNET_ETH_WALLET_PASSWORD }}

jobs:
  e2e-testnet:
    name: E2E Testnet Tests
    runs-on: warp-ubuntu-latest-x64-8x
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: FuelLabs/github-actions/setups/node@master
        with:
          node-version: 20.15.1
          pnpm-version: 9.10.0

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Setup Synpress (MetaMask)
        run: xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" -- pnpm --filter=e2e-tests setup:synpress
        env:
          DISPLAY: ':99'

      # Add delay to allow extensions to fully initialize (similar to node:start time in pr-tests)
      - name: Wait for extensions to stabilize
        run: sleep 30

      - name: Run E2E Hard Tests (Testnet)
        run: xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" -- pnpm test:e2e
        timeout-minutes: 20
        env:
          CI: true
          DISPLAY: ':99'
          E2E_BASE_URL: ${{ env.E2E_BASE_URL }}
          FUEL_CHAIN_NAME: ${{ env.FUEL_CHAIN_NAME }}
          FUEL_PROVIDER_URL: ${{ env.FUEL_PROVIDER_URL }}
          ETH_NETWORK: ${{ env.ETH_NETWORK }}
          E2E_ETH_MNEMONIC: ${{ env.E2E_ETH_MNEMONIC }}
          E2E_FUEL_MNEMONIC: ${{ env.E2E_FUEL_MNEMONIC }}
          E2E_ETH_WALLET_PASSWORD: ${{ env.E2E_ETH_WALLET_PASSWORD }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-testnet-${{ github.run_id }}
          path: packages/e2e-tests/playwright-report/
          retention-days: 14

      - name: Upload blob report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: blob-report-testnet-${{ github.run_id }}
          path: packages/e2e-tests/blob-report/
          retention-days: 14

      # Upload videos, screenshots, and traces for debugging
      - name: Upload videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: videos-testnet-${{ github.run_id }}
          path: packages/e2e-tests/test-results/**/video.webm
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots-testnet-${{ github.run_id }}
          path: packages/e2e-tests/test-results/**/*.png
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload traces
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: traces-testnet-${{ github.run_id }}
          path: packages/e2e-tests/test-results/**/trace.zip
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload all test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-testnet-${{ github.run_id }}
          path: packages/e2e-tests/test-results/
          retention-days: 14
          if-no-files-found: ignore

  # TODO: Re-enable after testing is complete
  # notify-on-failure:
  #   name: Notify on Failure
  #   runs-on: ubuntu-latest
  #   needs: e2e-testnet
  #   if: failure()
  #   permissions:
  #     contents: read
  #     issues: write
  #   steps:
  #     - name: Create issue on failure
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const date = new Date().toISOString().split('T')[0];
  #           const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
  #
  #           await github.rest.issues.create({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             title: `[E2E Testnet] Daily test failure - ${date}`,
  #             body: `## E2E Testnet Daily Test Failure\n\n**Date:** ${date}\n**Workflow Run:** ${runUrl}\n\nThe daily E2E testnet tests have failed. Please investigate.\n\n---\n*This issue was automatically created by the E2E Testnet Cron workflow.*`,
  #             labels: ['bug', 'e2e', 'automated']
  #           });
