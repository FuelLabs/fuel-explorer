name: E2E Testnet Cron

on:
  schedule:
    # Runs daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean
  # TODO: Remove after testing
  push:
    branches:
      - nj/feat/cron-e2e

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Chain configuration for testnet
  VITE_FUEL_CHAIN_NAME: fuelTestnet
  VITE_FUEL_PROVIDER: https://testnet.fuel.network/v1/graphql
  FUEL_CHAIN_NAME: fuelTestnet
  FUEL_PROVIDER_URL: https://testnet.fuel.network/v1/graphql
  ETH_NETWORK: sepolia

  # Turbo cache
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
  TURBO_REMOTE_ONLY: true

  # API configuration (from secrets)
  VITE_FUEL_INDEXER_API: ${{ secrets.E2E_TESTNET_INDEXER_API }}
  VITE_FUEL_INDEXER_API_KEY: ${{ secrets.E2E_TESTNET_INDEXER_API_KEY }}

  # Wallet mnemonics (from secrets - must have testnet funds)
  E2E_ETH_MNEMONIC: ${{ secrets.E2E_TESTNET_ETH_MNEMONIC }}
  E2E_FUEL_MNEMONIC: ${{ secrets.E2E_TESTNET_FUEL_MNEMONIC }}
  E2E_ETH_WALLET_PASSWORD: ${{ secrets.E2E_TESTNET_ETH_WALLET_PASSWORD }}

  # Optional: Additional env vars for testnet
  VITE_WALLETCONNECT_ID: ${{ secrets.E2E_TESTNET_WALLETCONNECT_ID }}
  VITE_INFURA_ID: ${{ secrets.E2E_TESTNET_INFURA_ID }}
  VITE_ALCHEMY_ID: ${{ secrets.E2E_TESTNET_ALCHEMY_ID }}
  VITE_COSMOS_API_TESTNET: ${{ secrets.E2E_TESTNET_COSMOS_API }}
  VITE_COSMOS_INDEXER_API_TESTNET: ${{ secrets.E2E_TESTNET_COSMOS_INDEXER_API }}
  VITE_COMET_SECURE_API_TESTNET: ${{ secrets.E2E_TESTNET_COMET_SECURE_API }}
  VITE_STAKING_ENV: testnet

jobs:
  e2e-testnet:
    name: E2E Testnet Tests
    runs-on: warp-ubuntu-latest-x64-8x
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-e2e-testnet-turbo-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-e2e-testnet-turbo-

      - name: Setup Node
        uses: FuelLabs/github-actions/setups/node@master
        with:
          node-version: 20.15.1
          pnpm-version: 9.10.0

      - name: Create .env file for explorer
        run: |
          cat > packages/app-explorer/.env << EOF
          VITE_FUEL_CHAIN_NAME=${VITE_FUEL_CHAIN_NAME}
          VITE_FUEL_PROVIDER=${VITE_FUEL_PROVIDER}
          VITE_FUEL_INDEXER_API=${VITE_FUEL_INDEXER_API}
          VITE_FUEL_INDEXER_API_KEY=${VITE_FUEL_INDEXER_API_KEY}
          VITE_WALLETCONNECT_ID=${VITE_WALLETCONNECT_ID}
          VITE_INFURA_ID=${VITE_INFURA_ID}
          VITE_ALCHEMY_ID=${VITE_ALCHEMY_ID}
          VITE_COSMOS_API_TESTNET=${VITE_COSMOS_API_TESTNET}
          VITE_COSMOS_INDEXER_API_TESTNET=${VITE_COSMOS_INDEXER_API_TESTNET}
          VITE_COMET_SECURE_API_TESTNET=${VITE_COMET_SECURE_API_TESTNET}
          VITE_STAKING_ENV=${VITE_STAKING_ENV}
          EOF

      - name: Create .env file for graphql
        run: |
          cat > packages/graphql/.env << EOF
          FUEL_PROVIDER=${VITE_FUEL_PROVIDER}
          EOF

      - name: Build production version of explorer
        env:
          NODE_ENV: test
        run: pnpm build:prod

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Setup Synpress (MetaMask)
        run: xvfb-run --auto-servernum -- pnpm --filter=e2e-tests setup:synpress

      - name: Run E2E Hard Tests (Testnet)
        run: xvfb-run --auto-servernum -- pnpm test:e2e
        env:
          CI: true
          FUEL_CHAIN_NAME: ${{ env.FUEL_CHAIN_NAME }}
          FUEL_PROVIDER_URL: ${{ env.FUEL_PROVIDER_URL }}
          ETH_NETWORK: ${{ env.ETH_NETWORK }}
          E2E_ETH_MNEMONIC: ${{ env.E2E_ETH_MNEMONIC }}
          E2E_FUEL_MNEMONIC: ${{ env.E2E_FUEL_MNEMONIC }}
          E2E_ETH_WALLET_PASSWORD: ${{ env.E2E_ETH_WALLET_PASSWORD }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-testnet-${{ github.run_id }}
          path: packages/e2e-tests/playwright-report/
          retention-days: 14

      - name: Upload blob report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: blob-report-testnet-${{ github.run_id }}
          path: packages/e2e-tests/blob-report/
          retention-days: 14

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: e2e-testnet
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[E2E Testnet] Daily test failure - ${date}`,
              body: `## E2E Testnet Daily Test Failure\n\n**Date:** ${date}\n**Workflow Run:** ${runUrl}\n\nThe daily E2E testnet tests have failed. Please investigate.\n\n---\n*This issue was automatically created by the E2E Testnet Cron workflow.*`,
              labels: ['bug', 'e2e', 'automated']
            });
